<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Gesti√≥n de Tareas</title>
  <link rel="stylesheet" th:href="@{/css/styles.css}">
</head>
<body>
<div class="container">
  <h1>üìã Sistema de Gesti√≥n de Tareas</h1>

  <div class="stats-bar" id="estadisticas">
    Cargando estad√≠sticas...
  </div>

  <div class="grid">
    <!-- Secci√≥n: Lista/Arreglo - Gesti√≥n de Tareas -->
    <div class="section">
      <h2>üìù Lista/Arreglo - Gesti√≥n de Tareas</h2>

      <h3>Agregar Nueva Tarea</h3>
      <div class="form-group">
        <label>T√≠tulo:</label>
        <input type="text" id="titulo" placeholder="Ej: Estudiar para el examen">
      </div>
      <div class="form-group">
        <label>Descripci√≥n:</label>
        <textarea id="descripcion" rows="3" placeholder="Descripci√≥n de la tarea"></textarea>
      </div>
      <div class="form-group">
        <label>Prioridad:</label>
        <select id="prioridad">
          <option value="ALTA">Alta</option>
          <option value="MEDIA" selected>Media</option>
          <option value="BAJA">Baja</option>
        </select>
      </div>
      <button onclick="agregarTarea()">‚ûï Agregar Tarea</button>

      <h3>Buscar Tareas</h3>
      <div class="search-box">
        <input type="text" id="buscarTitulo" placeholder="Buscar por t√≠tulo...">
        <button onclick="buscarTareas()">üîç Buscar</button>
      </div>

      <h3>Lista de Tareas</h3>
      <div class="tareas-list" id="listaTareas">
        <div class="empty-message">No hay tareas. Agrega una nueva tarea para comenzar.</div>
      </div>
    </div>

    <!-- Secci√≥n: Pila - Historial de Acciones -->
    <div class="section">
      <h2>üìö Pila (LIFO) - Historial de Acciones</h2>
      <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">
        El √∫ltimo elemento ingresado es el primero en salir (Last In, First Out)
      </p>

      <div class="actions-buttons">
        <button onclick="cargarHistorial()">üîÑ Actualizar Historial</button>
        <button class="btn-info" onclick="verUltimaAccion()">üëÅÔ∏è Ver √öltima Acci√≥n</button>
        <button class="btn-danger" onclick="deshacerAccion()">‚Ü©Ô∏è Deshacer √öltima Acci√≥n</button>
      </div>

      <h3>Historial Completo</h3>
      <div class="tareas-list" id="historialAcciones">
        <div class="empty-message">No hay acciones registradas a√∫n.</div>
      </div>
    </div>

    <!-- Secci√≥n: Cola - Tareas Pendientes -->
    <div class="section">
      <h2>üîÑ Cola (FIFO) - Tareas Pendientes</h2>
      <p style="color: #666; font-size: 0.9em; margin-bottom: 15px;">
        El primer elemento ingresado es el primero en salir (First In, First Out)
      </p>

      <div class="actions-buttons">
        <button onclick="cargarCola()">üîÑ Actualizar Cola</button>
        <button class="btn-info" onclick="verSiguienteTarea()">üëÅÔ∏è Ver Siguiente</button>
        <button class="btn-success" onclick="procesarSiguiente()">‚úÖ Procesar Siguiente</button>
      </div>

      <h3>Tareas en Cola</h3>
      <div class="tareas-list" id="colaTareas">
        <div class="empty-message">No hay tareas en la cola.</div>
      </div>
    </div>
  </div>
</div>

<script>
  const API_BASE = '/api';

  // Cargar datos al iniciar
  window.onload = function() {
    cargarTareas();
    cargarHistorial();
    cargarCola();
    actualizarEstadisticas();
  };

  // ========== FUNCIONES PARA LISTA/ARREGLO ==========

  async function agregarTarea() {
    const titulo = document.getElementById('titulo').value;
    const descripcion = document.getElementById('descripcion').value;
    const prioridad = document.getElementById('prioridad').value;

    if (!titulo.trim()) {
      alert('Por favor ingresa un t√≠tulo para la tarea');
      return;
    }

    try {
      const response = await fetch(`${API_BASE}/tareas`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ titulo, descripcion, prioridad })
      });

      if (response.ok) {
        document.getElementById('titulo').value = '';
        document.getElementById('descripcion').value = '';
        cargarTareas();
        cargarHistorial();
        cargarCola();
        actualizarEstadisticas();
        alert('‚úÖ Tarea agregada correctamente');
      } else {
        alert('Error al agregar la tarea');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error al agregar la tarea');
    }
  }

  async function cargarTareas() {
    try {
      const response = await fetch(`${API_BASE}/tareas`);
      const tareas = await response.json();
      mostrarTareas(tareas);
    } catch (error) {
      console.error('Error al cargar tareas:', error);
    }
  }

  function mostrarTareas(tareas) {
    const container = document.getElementById('listaTareas');

    if (tareas.length === 0) {
      container.innerHTML = '<div class="empty-message">No hay tareas. Agrega una nueva tarea para comenzar.</div>';
      return;
    }

    container.innerHTML = tareas.map(tarea => `
                <div class="tarea-item ${tarea.estado === 'COMPLETADA' ? 'completada' : tarea.estado === 'EN_PROGRESO' ? 'en-progreso' : ''}">
                    <div class="tarea-header">
                        <div class="tarea-titulo">${tarea.titulo}</div>
                        <span class="tarea-prioridad prioridad-${tarea.prioridad.toLowerCase()}">
                            ${tarea.prioridad}
                        </span>
                    </div>
                    <div style="color: #666; margin-bottom: 5px;">${tarea.descripcion || 'Sin descripci√≥n'}</div>
                    <span class="tarea-estado estado-${tarea.estado.toLowerCase().replace('_', '-')}">
                        ${tarea.estado.replace('_', ' ')}
                    </span>
                    <div class="tarea-acciones">
                        ${tarea.estado !== 'COMPLETADA' ?
            `<button class="btn-success" onclick="completarTarea(${tarea.id})">‚úÖ Completar</button>` :
            ''
    }
                        <button class="btn-danger" onclick="eliminarTarea(${tarea.id})">üóëÔ∏è Eliminar</button>
                    </div>
                </div>
            `).join('');
  }
  async function eliminarTarea(id) {
    if (!confirm('¬øEst√°s seguro de eliminar esta tarea?')) return;

    try {
      const response = await fetch(`${API_BASE}/tareas/${id}`, {
        method: 'DELETE'
      });

      if (response.ok) {
        cargarTareas();
        cargarHistorial();
        actualizarEstadisticas();
        alert('‚úÖ Tarea eliminada');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error al eliminar la tarea');
    }
  }

  async function completarTarea(id) {
    try {
      const response = await fetch(`${API_BASE}/tareas/${id}/completar`, {
        method: 'POST'
      });

      if (response.ok) {
        cargarTareas();
        cargarHistorial();
        actualizarEstadisticas();
        alert('‚úÖ Tarea completada');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error al completar la tarea');
    }
  }

  async function buscarTareas() {
    const titulo = document.getElementById('buscarTitulo').value;
    if (!titulo.trim()) {
      cargarTareas();
      return;
    }

    try {
      const response = await fetch(`${API_BASE}/tareas/buscar?titulo=${encodeURIComponent(titulo)}`);
      const tareas = await response.json();
      mostrarTareas(tareas);
    } catch (error) {
      console.error('Error:', error);
    }
  }

  // Permitir buscar con Enter
  document.getElementById('buscarTitulo').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      buscarTareas();
    }
  });

  // ========== FUNCIONES PARA PILA (HISTORIAL) ==========

  async function cargarHistorial() {
    try {
      const response = await fetch(`${API_BASE}/historial`);
      const historial = await response.json();
      mostrarHistorial(historial);
    } catch (error) {
      console.error('Error al cargar historial:', error);
    }
  }

  function mostrarHistorial(historial) {
    const container = document.getElementById('historialAcciones');

    if (historial.length === 0) {
      container.innerHTML = '<div class="empty-message">No hay acciones registradas a√∫n.</div>';
      return;
    }

    // Mostrar en orden inverso (√∫ltimo primero, como LIFO)
    const historialInvertido = [...historial].reverse();
    container.innerHTML = historialInvertido.map(accion => {
      const fecha = new Date(accion.fechaHora).toLocaleString('es-ES');
      return `
                    <div class="historial-item">
                        <strong>${accion.tipo}</strong>: ${accion.descripcion}
                        <div style="color: #999; font-size: 0.8em; margin-top: 5px;">${fecha}</div>
                    </div>
                `;
    }).join('');
  }

  async function verUltimaAccion() {
    try {
      const response = await fetch(`${API_BASE}/historial/ultima`);
      if (response.status === 204) {
        alert('No hay acciones en el historial');
        return;
      }
      const accion = await response.json();
      const fecha = new Date(accion.fechaHora).toLocaleString('es-ES');
      alert(`√öltima acci√≥n:\n${accion.tipo}: ${accion.descripcion}\nFecha: ${fecha}`);
    } catch (error) {
      console.error('Error:', error);
    }
  }

  async function deshacerAccion() {
    if (!confirm('¬øDeshacer la √∫ltima acci√≥n?')) return;

    try {
      const response = await fetch(`${API_BASE}/historial/deshacer`, {
        method: 'POST'
      });

      if (response.status === 204) {
        alert('No hay acciones para deshacer');
        return;
      }

      if (response.ok) {
        const accion = await response.json();
        cargarHistorial();
        cargarTareas();
        actualizarEstadisticas();
        alert(`‚úÖ Acci√≥n deshecha: ${accion.tipo} - ${accion.descripcion}`);
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error al deshacer la acci√≥n');
    }
  }

  // ========== FUNCIONES PARA COLA ==========

  async function cargarCola() {
    try {
      const response = await fetch(`${API_BASE}/cola`);
      const tareas = await response.json();
      mostrarCola(tareas);
    } catch (error) {
      console.error('Error al cargar cola:', error);
    }
  }

  function mostrarCola(tareas) {
    const container = document.getElementById('colaTareas');

    if (tareas.length === 0) {
      container.innerHTML = '<div class="empty-message">No hay tareas en la cola.</div>';
      return;
    }

    container.innerHTML = tareas.map((tarea, index) => `
                <div class="cola-item">
                    <div style="font-weight: bold; margin-bottom: 5px;">
                        #${index + 1} - ${tarea.titulo}
                    </div>
                    <div style="color: #666; font-size: 0.9em;">
                        Prioridad: ${tarea.prioridad} | Estado: ${tarea.estado.replace('_', ' ')}
                    </div>
                </div>
            `).join('');
  }

  async function verSiguienteTarea() {
    try {
      const response = await fetch(`${API_BASE}/cola`);
      const tareas = await response.json();
      if (tareas.length === 0) {
        alert('No hay tareas en la cola');
        return;
      }
      const siguiente = tareas[0];
      alert(`Siguiente tarea a procesar:\n\n${siguiente.titulo}\nPrioridad: ${siguiente.prioridad}`);
    } catch (error) {
      console.error('Error:', error);
    }
  }

  async function procesarSiguiente() {
    if (!confirm('¬øProcesar la siguiente tarea de la cola?')) return;

    try {
      const response = await fetch(`${API_BASE}/cola/procesar`, {
        method: 'POST'
      });

      if (response.status === 204) {
        alert('No hay tareas en la cola para procesar');
        return;
      }

      if (response.ok) {
        const tarea = await response.json();
        cargarCola();
        actualizarEstadisticas();
        alert(`‚úÖ Tarea procesada: ${tarea.titulo}`);
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Error al procesar la tarea');
    }
  }

  // ========== ESTAD√çSTICAS ==========

  async function actualizarEstadisticas() {
    try {
      const response = await fetch(`${API_BASE}/estadisticas`);
      const data = await response.json();
      document.getElementById('estadisticas').textContent = `üìä ${data.estadisticas}`;
    } catch (error) {
      console.error('Error al cargar estad√≠sticas:', error);
    }
  }

  // Actualizar estad√≠sticas cada 5 segundos
  setInterval(actualizarEstadisticas, 5000);
</script>
</body>
</html>


