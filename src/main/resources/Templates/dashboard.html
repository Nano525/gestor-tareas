<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org" th:replace="~{layout :: layout(titulo='Dashboard', activePage='dashboard', content=~{::content})}">
<th:block th:fragment="content">
    <div class="page-header">
        <h1>üè† Dashboard</h1>
        <p>Vista general del sistema de gesti√≥n de tareas</p>
    </div>

    <div class="stats-bar" id="estadisticas">
        Cargando estad√≠sticas...
    </div>

    <div class="section" style="margin-top: 20px;">
        <h3>üîç Buscar Tareas</h3>
        <div class="search-box">
            <input type="text" id="buscarTitulo" placeholder="Buscar por t√≠tulo...">
            <button onclick="buscarTareas()">üîç Buscar</button>
        </div>
        
        <div class="tareas-list" id="listaTareas" style="max-height: 400px; margin-top: 15px;">
            <div class="empty-message">No hay tareas. Agrega una nueva tarea para comenzar.</div>
        </div>
    </div>

    <div class="dashboard-grid">
        <div class="dashboard-card">
            <h3>üìù Tareas Activas</h3>
            <div class="tareas-list" id="tareasActivas" style="max-height: 300px;">
                <div class="empty-message">Cargando tareas...</div>
            </div>
        </div>

        <div class="dashboard-card">
            <h3>üìä Resumen R√°pido</h3>
            <div id="resumenRapido">
                <div class="resumen-item">
                    <span class="resumen-label">Total de Tareas:</span>
                    <span class="resumen-value" id="totalTareas">-</span>
                </div>
                <div class="resumen-item">
                    <span class="resumen-label">Pendientes:</span>
                    <span class="resumen-value" id="pendientes">-</span>
                </div>
                <div class="resumen-item">
                    <span class="resumen-label">En Progreso:</span>
                    <span class="resumen-value" id="enProgreso">-</span>
                </div>
                <div class="resumen-item">
                    <span class="resumen-label">En Cola:</span>
                    <span class="resumen-value" id="enCola">-</span>
                </div>
                <div class="resumen-item">
                    <span class="resumen-label">Historial:</span>
                    <span class="resumen-value" id="historial">-</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';

        window.onload = function() {
            cargarTareasActivas();
            actualizarEstadisticas();
            actualizarResumen();
            cargarTodasLasTareas();
            
            document.getElementById('buscarTitulo').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    buscarTareas();
                }
            });
        };

        async function cargarTareasActivas() {
            try {
                const response = await fetch(`${API_BASE}/tareas`);
                const data = await response.json();
                const tareas = Array.isArray(data) ? data : Object.values(data);
                mostrarTareasActivas(tareas);
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function mostrarTareasActivas(tareas) {
            const container = document.getElementById('tareasActivas');
            const tareasArray = Array.isArray(tareas) ? tareas : Object.values(tareas);
            const tareasActivas = tareasArray.filter(t => t.estado !== 'COMPLETADA');

            if (!tareasActivas || tareasActivas.length === 0) {
                container.innerHTML = '<div class="empty-message">No hay tareas activas.</div>';
                return;
            }

            container.innerHTML = tareasActivas.slice(0, 5).map(tarea => `
                <div class="tarea-item-mini ${tarea.estado === 'EN_PROGRESO' ? 'en-progreso' : ''}">
                    <div class="tarea-header">
                        <div class="tarea-titulo">${tarea.titulo}</div>
                        <span class="tarea-prioridad prioridad-${tarea.prioridad.toLowerCase()}">
                            ${tarea.prioridad}
                        </span>
                    </div>
                    <span class="tarea-estado estado-${tarea.estado.toLowerCase().replace('_', '-')}">
                        ${tarea.estado.replace('_', ' ')}
                    </span>
                </div>
            `).join('');
        }

        async function actualizarEstadisticas() {
            try {
                const response = await fetch(`${API_BASE}/estadisticas`);
                const data = await response.json();
                document.getElementById('estadisticas').textContent = `üìä ${data.estadisticas}`;
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function actualizarResumen() {
            try {
                const response = await fetch(`${API_BASE}/tareas`);
                const data = await response.json();
                const tareas = Array.isArray(data) ? data : Object.values(data);
                
                const total = tareas.length;
                const pendientes = tareas.filter(t => t.estado === 'PENDIENTE').length;
                const enProgreso = tareas.filter(t => t.estado === 'EN_PROGRESO').length;
                
                const colaResponse = await fetch(`${API_BASE}/cola`);
                const colaData = await colaResponse.json();
                const cola = Array.isArray(colaData) ? colaData : Object.values(colaData);
                const enCola = cola.length;
                
                const historialResponse = await fetch(`${API_BASE}/historial`);
                const historialData = await historialResponse.json();
                const historial = Array.isArray(historialData) ? historialData : Object.values(historialData);
                const historialCount = historial.length;
                
                document.getElementById('totalTareas').textContent = total;
                document.getElementById('pendientes').textContent = pendientes;
                document.getElementById('enProgreso').textContent = enProgreso;
                document.getElementById('enCola').textContent = enCola;
                document.getElementById('historial').textContent = historialCount;
            } catch (error) {
                console.error('Error:', error);
            }
        }

        async function cargarTodasLasTareas() {
            try {
                const response = await fetch(`${API_BASE}/tareas`);
                const data = await response.json();
                const tareas = Array.isArray(data) ? data : Object.values(data);
                mostrarTodasLasTareas(tareas);
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function mostrarTodasLasTareas(tareas) {
            const container = document.getElementById('listaTareas');
            const tareasArray = Array.isArray(tareas) ? tareas : Object.values(tareas);

            if (!tareasArray || tareasArray.length === 0) {
                container.innerHTML = '<div class="empty-message">No hay tareas. Agrega una nueva tarea para comenzar.</div>';
                return;
            }

            container.innerHTML = tareasArray.map(tarea => `
                <div class="tarea-item ${tarea.estado === 'COMPLETADA' ? 'completada' : tarea.estado === 'EN_PROGRESO' ? 'en-progreso' : ''}">
                    <div class="tarea-header">
                        <div class="tarea-titulo">${tarea.titulo}</div>
                        <span class="tarea-prioridad prioridad-${tarea.prioridad.toLowerCase()}">
                            ${tarea.prioridad}
                        </span>
                    </div>
                    <div style="color: #666; margin-bottom: 5px;">${tarea.descripcion || 'Sin descripci√≥n'}</div>
                    <span class="tarea-estado estado-${tarea.estado.toLowerCase().replace('_', '-')}">
                        ${tarea.estado.replace('_', ' ')}
                    </span>
                    <div class="tarea-acciones">
                        ${tarea.estado !== 'COMPLETADA' ?
                            `<button class="btn-success" onclick="completarTarea(${tarea.id})">‚úÖ Completar</button>` :
                            ''
                        }
                        <button class="btn-danger" onclick="eliminarTarea(${tarea.id})">üóëÔ∏è Eliminar</button>
                    </div>
                </div>
            `).join('');
        }

        async function eliminarTarea(id) {
            if (!confirm('¬øEst√°s seguro de eliminar esta tarea?')) return;

            try {
                const response = await fetch(`${API_BASE}/tareas/${id}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    cargarTodasLasTareas();
                    cargarTareasActivas();
                    actualizarEstadisticas();
                    actualizarResumen();
                    alert('‚úÖ Tarea eliminada');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al eliminar la tarea');
            }
        }

        async function completarTarea(id) {
            try {
                const response = await fetch(`${API_BASE}/tareas/${id}/completar`, {
                    method: 'POST'
                });

                if (response.ok) {
                    cargarTodasLasTareas();
                    cargarTareasActivas();
                    actualizarEstadisticas();
                    actualizarResumen();
                    alert('‚úÖ Tarea completada y eliminada autom√°ticamente');
                }
            } catch (error) {
                console.error('Error:', error);
                alert('Error al completar la tarea');
            }
        }

        async function buscarTareas() {
            const titulo = document.getElementById('buscarTitulo').value;
            if (!titulo.trim()) {
                cargarTodasLasTareas();
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/tareas/buscar?titulo=${encodeURIComponent(titulo)}`);
                const data = await response.json();
                const tareas = Array.isArray(data) ? data : Object.values(data);
                mostrarTodasLasTareas(tareas);
            } catch (error) {
                console.error('Error:', error);
            }
        }

        setInterval(() => {
            cargarTareasActivas();
            actualizarEstadisticas();
            actualizarResumen();
        }, 5000);
    </script>
</th:block>
